<?xml version="1.0" encoding="UTF-8"?><record_update sys_domain="global" table="catalog_script_client">
    <catalog_script_client action="INSERT_OR_UPDATE">
        <active>true</active>
        <applies_catalog>true</applies_catalog>
        <applies_extended>false</applies_extended>
        <applies_req_item>false</applies_req_item>
        <applies_sc_task>false</applies_sc_task>
        <applies_target_record>false</applies_target_record>
        <applies_to>item</applies_to>
        <cat_item display_value="Car Parking Reservation">48ece84bc325f290ec76502ed40131e5</cat_item>
        <cat_variable>IO:17f7ae47c3e13690ec76502ed40131b3</cat_variable>
        <condition/>
        <description/>
        <field/>
        <global>true</global>
        <isolate_script>true</isolate_script>
        <messages/>
        <name>Validate End Date Time</name>
        <order/>
        <published_ref/>
        <script><![CDATA[function onChange(control, oldValue, newValue, isLoading, isTemplate) {
    
    if (isLoading || isTemplate) {
        return;
    }
    
    if (!newValue) {
        return;
    }
    
    // ดึงค่า Start Date Time
    var startDateTime = g_form.getValue('start_date_time');
    
    if (!startDateTime) {
        g_form.showFieldMsg(
            'end_date_time',
            '⚠️ กรุณาเลือกวันเริ่มต้นก่อน',
            'warning'
        );
        g_form.clearValue('end_date_time');
        return;
    }
    
    // แปลงเป็น Date object
    var startDate = new Date(startDateTime);
    var endDate = new Date(newValue);
    
    // ========================================
    // ตรวจสอบ: End ต้องมากกว่า Start
    // ========================================
    
    if (endDate <= startDate) {
        g_form.showFieldMsg(
            'end_date_time',
            '❌ เวลาสิ้นสุดต้องมากกว่าเวลาเริ่มต้น',
            'error'
        );
        
        // ล้างค่า
        g_form.clearValue('end_date_time');
        g_form.clearValue('duration_hours');
        g_form.clearValue('parking_fee');
        
        return;
    }
    
    // ========================================
    // ตรวจสอบ: End ไม่เป็นอดีต
    // ========================================
    
    var now = new Date();
    
    if (endDate < now) {
        g_form.showFieldMsg(
            'end_date_time',
            '❌ ไม่สามารถเลือกเวลาย้อนหลังได้',
            'error'
        );
        
        g_form.clearValue('end_date_time');
        g_form.clearValue('duration_hours');
        g_form.clearValue('parking_fee');
        
        return;
    }
    
    // ========================================
    // ตรวจสอบ: ระยะเวลาสูงสุด (optional)
    // ========================================
    
    var diffMs = endDate - startDate;
    var diffHours = diffMs / (1000 * 60 * 60);
    
    // ถ้าเกิน 168 ชม (7 วัน) แสดง warning
    if (diffHours > 168) {
        g_form.showFieldMsg(
            'end_date_time',
            '⚠️ การจองเกิน 7 วัน กรุณาติดต่อเจ้าหน้าที่',
            'warning',
            5000
        );
    }
    
    // ล้าง error message
    g_form.hideFieldMsg('end_date_time', true);
    
    // แสดง success message
    var durationText = Math.ceil(diffHours) + ' ชั่วโมง';
    if (diffHours >= 24) {
        var days = Math.floor(diffHours / 24);
        var hours = Math.ceil(diffHours % 24);
        durationText = days + ' วัน ' + hours + ' ชั่วโมง';
    }
    
    g_form.showFieldMsg(
        'end_date_time',
        '✓ ระยะเวลา: ' + durationText,
        'info',
        3000
    );
}]]></script>
        <sys_class_name>catalog_script_client</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2025-12-15 07:32:12</sys_created_on>
        <sys_domain>global</sys_domain>
        <sys_domain_path>/</sys_domain_path>
        <sys_id>38f20e0ac3b1ba10ec76502ed4013102</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_name>Validate End Date Time</sys_name>
        <sys_overrides/>
        <sys_package display_value="Parking Reservation System" source="x_1869622_parkin_0">6ea533f6c3adb290ec76502ed4013190</sys_package>
        <sys_policy/>
        <sys_scope display_value="Parking Reservation System">6ea533f6c3adb290ec76502ed4013190</sys_scope>
        <sys_update_name>catalog_script_client_38f20e0ac3b1ba10ec76502ed4013102</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2025-12-15 07:32:12</sys_updated_on>
        <table/>
        <type>onChange</type>
        <ui_type>10</ui_type>
        <va_supported>true</va_supported>
        <variable_set/>
        <view/>
    </catalog_script_client>
</record_update>
