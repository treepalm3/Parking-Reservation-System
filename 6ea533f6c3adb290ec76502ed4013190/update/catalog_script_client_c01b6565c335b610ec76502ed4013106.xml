<?xml version="1.0" encoding="UTF-8"?><record_update sys_domain="global" table="catalog_script_client">
    <catalog_script_client action="INSERT_OR_UPDATE">
        <active>true</active>
        <applies_catalog>true</applies_catalog>
        <applies_extended>false</applies_extended>
        <applies_req_item>false</applies_req_item>
        <applies_sc_task>false</applies_sc_task>
        <applies_target_record>false</applies_target_record>
        <applies_to>item</applies_to>
        <cat_item display_value="Car Parking Reservation">48ece84bc325f290ec76502ed40131e5</cat_item>
        <cat_variable>IO:17f7ae47c3e13690ec76502ed40131b3</cat_variable>
        <condition/>
        <description/>
        <field/>
        <global>true</global>
        <isolate_script>true</isolate_script>
        <messages/>
        <name>Auto Calculate Duration and Fee</name>
        <order/>
        <published_ref/>
        <script><![CDATA[function onChange(control, oldValue, newValue, isLoading, isTemplate) {
    
    if (isLoading || isTemplate) {
        return;
    }
    
    var startDateTime = g_form.getValue('start_date_time');
    var endDateTime = g_form.getValue('end_date_time');
    
    if (!startDateTime || !endDateTime) {
        return;
    }
    
    var startDate = new Date(startDateTime);
    var endDate = new Date(endDateTime);
    
    if (endDate <= startDate) {
        g_form.showFieldMsg(
            'end_date_time',
            'âŒ à¹€à¸§à¸¥à¸²à¸ªà¸´à¹‰à¸™à¸ªà¸¸à¸”à¸•à¹‰à¸­à¸‡à¸¡à¸²à¸à¸à¸§à¹ˆà¸²à¹€à¸§à¸¥à¸²à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™',
            'error'
        );
        g_form.clearValue('end_date_time');
        g_form.clearValue('duration_hours');
        g_form.clearValue('parking_fee');
        return;
    }
    
    // ========================================
    // à¸„à¸³à¸™à¸§à¸“ Duration
    // ========================================
    
    var diffMs = endDate - startDate;
    var diffHours = diffMs / (1000 * 60 * 60);
    var durationHours = Math.ceil(diffHours); // à¸›à¸±à¸”à¸‚à¸¶à¹‰à¸™
    
    g_form.setValue('duration_hours', durationHours);
    
    // ========================================
    // à¸„à¸³à¸™à¸§à¸“ Parking Fee
    // ========================================
    
    var parkingFee = 0;
    var feeBreakdown = [];
    
    // à¸„à¸³à¸™à¸§à¸“à¸ˆà¸³à¸™à¸§à¸™à¸§à¸±à¸™à¹€à¸•à¹‡à¸¡ (24 à¸Šà¸¡/à¸§à¸±à¸™)
    var fullDays = Math.floor(durationHours / 24);
    var remainingHours = durationHours % 24;
    
    // à¸„à¸´à¸”à¸„à¹ˆà¸²à¸§à¸±à¸™à¹€à¸•à¹‡à¸¡ (200 à¸šà¸²à¸—/à¸§à¸±à¸™)
    if (fullDays > 0) {
        var daysFee = fullDays * 200;
        parkingFee += daysFee;
        feeBreakdown.push(fullDays + ' à¸§à¸±à¸™ Ã— 200 = ' + daysFee + ' à¸šà¸²à¸—');
    }
    
    // à¸„à¸³à¸™à¸§à¸“à¸Šà¸±à¹ˆà¸§à¹‚à¸¡à¸‡à¸—à¸µà¹ˆà¹€à¸«à¸¥à¸·à¸­
    if (remainingHours > 0) {
        
        // à¸–à¹‰à¸²à¸Šà¸±à¹ˆà¸§à¹‚à¸¡à¸‡à¸—à¸µà¹ˆà¹€à¸«à¸¥à¸·à¸­ > 8 = à¹€à¸«à¸¡à¸²à¸­à¸µà¸ 200
        if (remainingHours > 8) {
            parkingFee += 200;
            feeBreakdown.push(remainingHours + ' à¸Šà¸¡ (à¹€à¸«à¸¡à¸²) = 200 à¸šà¸²à¸—');
        }
        // à¸–à¹‰à¸² â‰¤ 8 à¸Šà¸¡ à¸„à¸´à¸”à¹à¸šà¸š progressive
        else {
            var hourlyFee = 0;
            var hourlyBreakdown = [];
            var hoursLeft = remainingHours;
            
            // Tier 1: à¸Šà¸¡.à¹à¸£à¸ = 10 à¸šà¸²à¸—
            if (hoursLeft > 0) {
                var tier1 = Math.min(hoursLeft, 1);
                var tier1Fee = tier1 * 10;
                hourlyFee += tier1Fee;
                hourlyBreakdown.push('10');
                hoursLeft -= tier1;
            }
            
            // Tier 2: à¸Šà¸¡.à¸—à¸µà¹ˆ 2-4 = 15 à¸šà¸²à¸—/à¸Šà¸¡
            if (hoursLeft > 0) {
                var tier2 = Math.min(hoursLeft, 3);
                var tier2Fee = tier2 * 15;
                hourlyFee += tier2Fee;
                for (var i = 0; i < tier2; i++) {
                    hourlyBreakdown.push('15');
                }
                hoursLeft -= tier2;
            }
            
            // Tier 3: à¸Šà¸¡.à¸—à¸µà¹ˆ 5-8 = 20 à¸šà¸²à¸—/à¸Šà¸¡
            if (hoursLeft > 0) {
                var tier3 = Math.min(hoursLeft, 4);
                var tier3Fee = tier3 * 20;
                hourlyFee += tier3Fee;
                for (var i = 0; i < tier3; i++) {
                    hourlyBreakdown.push('20');
                }
            }
            
            parkingFee += hourlyFee;
            feeBreakdown.push(remainingHours + ' à¸Šà¸¡: ' + hourlyBreakdown.join('+') + ' = ' + hourlyFee + ' à¸šà¸²à¸—');
        }
    }
    
    // à¹à¸ªà¸”à¸‡à¸œà¸¥
    g_form.setValue('parking_fee', parkingFee);
    
    // ========================================
    // Success Message
    // ========================================
    
    g_form.hideFieldMsg('end_date_time', true);
    
    var summaryMsg = ']]>ðŸ’°<![CDATA[ à¸£à¸§à¸¡ ' + durationHours + ' à¸Šà¸¡ = ' + parkingFee + ' à¸šà¸²à¸—';
    if (feeBreakdown.length > 0) {
        summaryMsg += '\n' + feeBreakdown.join(' + ');
    }
    
    g_form.showFieldMsg(
        'parking_fee',
        summaryMsg,
        'info',
        5000
    );
    
    g_form.flash('duration_hours', '#00FF00', 1);
    g_form.flash('parking_fee', '#00FF00', 1);
}]]></script>
        <sys_class_name>catalog_script_client</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2025-12-13 16:33:20</sys_created_on>
        <sys_domain>global</sys_domain>
        <sys_domain_path>/</sys_domain_path>
        <sys_id>c01b6565c335b610ec76502ed4013106</sys_id>
        <sys_mod_count>3</sys_mod_count>
        <sys_name>Auto Calculate Duration and Fee</sys_name>
        <sys_overrides/>
        <sys_package display_value="Parking Reservation System" source="x_1869622_parkin_0">6ea533f6c3adb290ec76502ed4013190</sys_package>
        <sys_policy/>
        <sys_scope display_value="Parking Reservation System">6ea533f6c3adb290ec76502ed4013190</sys_scope>
        <sys_update_name>catalog_script_client_c01b6565c335b610ec76502ed4013106</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2025-12-13 16:54:12</sys_updated_on>
        <table/>
        <type>onChange</type>
        <ui_type>1</ui_type>
        <va_supported>false</va_supported>
        <variable_set/>
        <view/>
    </catalog_script_client>
</record_update>
